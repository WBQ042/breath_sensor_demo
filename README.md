# 医用呼吸机边缘控制系统

基于ESP32的智能呼吸机控制系统，集成多种传感器实时监测呼吸参数，并通过OLED显示屏和WiFi网络传输数据。

## 项目概述

本系统是一个医用呼吸机边缘控制系统，用于实时监测患者的呼吸参数（气压、流量、CO2浓度、氧气浓度）并控制气阀，提供呼吸辅助。系统通过I2C多路复用器管理多个传感器，实现了模块化和高可靠性的设计。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      ESP32主控板                              │
│                                                              │
│  ┌──────────────┐                                           │
│  │ BreathController  │  核心控制逻辑                         │
│  └──────────────┘                                           │
│         │                                                   │
│         ├──► I2C Multiplexer (TCA9548, 地址0x70)           │
│         │    ├── 通道0: 流量传感器                           │
│         │    ├── 通道1: 主气压传感器                         │
│         │    ├── 通道2: OLED显示屏                          │
│         │    ├── 通道3: 备用气压传感器                       │
│         │    ├── 通道4: ACD1100 CO2传感器                   │
│         │    └── 通道5: ADS1115 ADC (氧传感器)              │
│         │                                                   │
│         ├──► WiFi模块 - 数据传输                            │
│         └──► GPIO3 - 气阀控制                               │
└─────────────────────────────────────────────────────────────┘
```

## 主要文件说明

### 核心文件

#### 1. `sketch_oct9a.ino` - 主程序
**作用**: 系统入口，负责初始化所有模块和主循环控制
- **主要功能**:
  - 初始化I2C多路复用器和各传感器
  - 配置WiFi连接参数
  - 协调所有传感器数据采集
  - 系统诊断和状态输出

#### 2. `BreathController.cpp/h` - 呼吸控制器
**作用**: 核心控制逻辑，管理所有传感器和呼吸检测
- **主要功能**:
  - **气压传感器管理**: 读取气压数据，进行滤波处理
  - **流量传感器管理**: 检测并读取流量数据
  - **ACD1100管理**: 读取CO2浓度和温度
  - **氧气传感器管理**: 通过ADS1115读取氧气浓度
  - **呼吸状态检测**: 识别呼气、吸气、峰值、低谷状态
  - **气阀控制**: 根据呼吸状态控制气阀开度
  - **WiFi通信**: 将数据发送到服务器
  - **OLED显示**: 更新屏幕显示

### 传感器驱动文件

#### 3. `I2CMux.cpp/h` - I2C多路复用器
**作用**: 管理TCA9548多路复用器，实现多个I2C设备的分时复用
- **主要功能**:
  - 通道切换管理
  - 设备地址配置
  - I2C设备扫描和诊断
  - 通道状态监测

#### 4. `OLEDDisplay.cpp/h` - OLED显示
**作用**: 控制SSD1306 OLED显示屏（128x64）
- **主要功能**:
  - 显示气压、CO2浓度、氧气浓度
  - 显示呼吸状态（呼气/吸气）
  - 显示WiFi连接状态

#### 5. `gas_concentration.cpp/h` - ACD1100 CO2传感器
**作用**: 读取ACD1100红外二氧化碳传感器数据
- **通信模式**: 支持I2C和UART双模式
  - I2C模式: 地址0x2A，100kHz速率
  - UART模式: 波特率1200，8N1格式
- **主要功能**:
  - CO2浓度读取（400-5000ppm范围）
  - 温度读取
  - 数据滤波（移动平均+EWMA）
  - 空气质量评估

#### 6. `ADS1115.cpp/h` - 16位ADC
**作用**: 读取高精度模拟信号
- **主要功能**:
  - 16位高精度ADC
  - 多通道输入
  - 用于氧传感器电压测量

#### 7. `oxygen_sensor.cpp/h` - 氧气传感器
**作用**: 读取电化学氧气传感器数据
- **主要功能**:
  - 零点校准
  - 大气环境校准
  - 氧气浓度计算（0-25%范围）

## 传感器配置

### I2C多路复用器通道分配

| 通道 | I2C地址 | 设备 | 状态 |
|------|---------|------|------|
| 0    | 0x50    | 流量传感器 | 待接入 |
| 1    | 0x6D    | 主气压传感器 | ✓ 已配置 |
| 2    | 0x3C    | OLED显示屏 | ✓ 已配置 |
| 3    | 0x6D    | 备用气压传感器 | ✓ 已配置 |
| 4    | 0x2A    | ACD1100 CO2传感器 | ✓ 已配置 |
| 5    | 0x4A    | ADS1115 ADC | ✓ 已配置 |

### 硬件连接

#### ESP32引脚分配
- **GPIO3**: 气阀控制（PWM输出）
- **GPIO34**: 氧传感器模拟输入（通过ADS1115）
- **I2C总线**: SDA/SCL用于I2C通信
- **Serial1**: TX(GPIO17), RX(GPIO16) - ACD1100 UART模式

#### ACD1100连接（UART模式）
- Pin1 (SDA/RX): 接ESP32 TX (GPIO17)
- Pin2 (SCL/TX): 接ESP32 RX (GPIO16)
- Pin3 (GND): 接ESP32 GND
- Pin4 (VCC): 接5V电源
- Pin5 (SET): 接GND（UART模式）

## WiFi配置

- **SSID**: Pressure_Breath
- **密码**: pressure
- **目标服务器**: 10.181.245.186:8080
- **数据格式**: JSON格式的传感器数据

## 开发进度

### ✅ 已完成功能

1. **I2C多路复用器系统**
   - ✓ TCA9548驱动完整实现
   - ✓ 多通道切换功能
   - ✓ 设备扫描和诊断

2. **气压传感器系统**
   - ✓ 主气压传感器读取
   - ✓ 备用气压传感器读取
   - ✓ 移动平均滤波
   - ✓ EWMA滤波
   - ✓ 串口输出（每1秒）

3. **OLED显示系统**
   - ✓ 显示屏初始化
   - ✓ 传感器数据显示
   - ✓ 呼吸状态显示
   - ✓ 格式化输出

4. **呼吸检测与控制**
   - ✓ 呼吸状态识别（呼气/吸气/峰值/低谷）
   - ✓ 气阀控制（基于PWM）
   - ✓ 自适应控制

5. **氧传感器系统**
   - ✓ ADS1115驱动
   - ✓ 氧传感器校准
   - ✓ 氧气浓度计算
   - ✓ 数据读取和输出

6. **ACD1100 CO2传感器（I2C模式）**
   - ✓ I2C通信实现
   - ✓ 数据读取和解析
   - ✓ CRC校验
   - ✓ 数据滤波
   - ✓ 串口输出（每2秒）

7. **WiFi通信**
   - ✓ WiFi连接管理
   - ✓ 自动重连
   - ✓ 数据发送

### 🚧 进行中功能

1. **ACD1100 UART模式**
   - ⚠️ UART通信模式已实现
   - ⚠️ 遇到传感器无响应问题（收到0字节）
   - ⚠️ 需要进一步调试

2. **流量传感器**
   - ⚠️ 传感器探测功能已实现
   - ⚠️ 等待硬件接入测试

### 📋 待实现功能

1. **系统优化**
   - [ ] ACD1100 UART模式调试完成
   - [ ] 流量传感器完整测试
   - [ ] 系统稳定性测试
   - [ ] 电源管理优化

2. **功能增强**
   - [ ] 数据记录到SD卡
   - [ ] 离线模式支持
   - [ ] 警报系统
   - [ ] 远程参数配置

## 使用方法

### 编译和上传

1. 使用Arduino IDE 1.8.13或更高版本
2. 安装ESP32开发板支持包
3. 选择开发板: ESP32 Dev Module
4. 选择串口: COM6（或当前连接的端口）
5. 上传速率: 115200
6. 点击上传

### 串口监视器设置

- 波特率: **115200**（保持不变）
- 行尾: 无行尾

### ACD1100模式切换

#### 使用I2C模式（默认）
- 无需修改代码，传感器直接通过多路复用器连接

#### 使用UART模式
在 `sketch_oct9a.ino` 第139-144行取消注释：
```cpp
breathController.setACD1100CommunicationMode(COMM_UART);
Serial1.begin(1200);
```

### 氧传感器校准

在首次使用前需要校准：
```cpp
breathController.initializeOxygenSensor();
// 校准会自动进行
```

## 调试信息

系统提供详细的串口调试信息：

### 启动信息
- I2C设备扫描结果
- 各传感器初始化状态
- WiFi连接状态
- 通道配置信息

### 运行时信息
- **气压传感器**: 每1秒输出一次
- **CO2传感器**: 每2秒输出一次
- **ACD1100调试**: 每5秒输出连接状态
- **WiFi状态**: 连接/重连时输出

## 已知问题

1. **ACD1100 UART模式无响应**
   - 现象: 传感器返回0字节
   - 可能原因: 接线问题、传感器Pin5配置、波特率匹配
   - 状态: 调试中

2. **流量传感器未接入**
   - 状态: 等待硬件现状

## 技术规格

- **主控芯片**: ESP32
- **工作电压**: 3.3V/5V
- **I2C速率**: 100kHz（适配ACD1100）
- **WiFi**: IEEE 802.11 b/g/n
- **功耗**: 待测定

## 依赖库

- Wire.h (I2C通信)
- WiFi.h (WiFi连接)
- WiFiClient.h (TCP通信)
- Adafruit_SSD1306 (OLED显示)
- SPI.h (SPI通信，OLED使用)

## 文件结构

```
test_demo/
├── sketch_oct9a.ino          # 主程序入口
├── BreathController.cpp/h    # 核心控制器
├── I2CMux.cpp/h              # I2C多路复用器
├── OLEDDisplay.cpp/h         # OLED显示
├── gas_concentration.cpp/h   # ACD1100 CO2传感器
├── ADS1115.cpp/h             # 16位ADC
├── oxygen_sensor.cpp/h       # 氧气传感器
├── README.md                 # 本文档
├── ACD1100说明.json          # CO2传感器技术文档
└── Server_pp.py              # 数据接收服务器
```

## 联系与支持

如有问题，请检查：
1. 串口监视器的详细调试信息
2. 硬件连接是否牢固
3. 传感器供电是否正常
4. WiFi配置是否正确

---

**项目版本**: v1.0  
**最后更新**: 2025年  
**开发状态**: 开发中

